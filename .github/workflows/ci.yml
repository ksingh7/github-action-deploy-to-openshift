on: push
jobs:
  build:
    name: Build, push, and deploy
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      QUAY_REGISTRY_SECRET: ${{ secrets.QUAY_REGISTRY_SECRET }}
      OPENSHIFT_SERVER_URL: ${{ secrets.OPENSHIFT_SERVER_URL }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
      REGISTRY_URL: "quay.io" # use "docker.io" for docker hub
    steps:
      - name: Checkout main
        uses: actions/checkout@v2

      - name: Update SHA
        run: echo $GITHUB_SHA > $GITHUB_WORKSPACE/_meta

      - uses: satackey/action-docker-layer-caching@v0.0.11
        continue-on-error: true

      - name: Build container image
        run: docker build -t ${{ env.REGISTRY_URL }}/karansingh/gha-python-app:$(echo $GITHUB_SHA | head -c7) .

      - name: Docker Login
        run: docker login -u ${{ env.DOCKER_USERNAME }} -p ${{ env.DOCKER_PASSWORD }} ${{ env.REGISTRY_URL }}

      - name: Push image to Docker Hub
        run: docker push ${{ env.REGISTRY_URL }}/karansingh/gha-python-app:$(echo $GITHUB_SHA | head -c7)

      - name: Update deployment file
        run:  TAG=$(echo $GITHUB_SHA | head -c7) && sed -i 's|<IMAGE>|${{ env.REGISTRY_URL }}/karansingh/gha-python-app:'${TAG}'|' $GITHUB_WORKSPACE/deploy-to-openshift.yaml

      - name: Update deployment file with image registry secret
        run: sed -i 's|<REGISTRY_SECRET>|${{ env.QUAY_REGISTRY_SECRET }}|' $GITHUB_WORKSPACE/deploy-to-openshift.yaml

      - name: Authenticate and set context
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ env.OPENSHIFT_SERVER_URL }}
          openshift_token: ${{ env.OPENSHIFT_TOKEN }}

      - name: Create image registry secret
        run: oc create secret docker-registry image-registry-secret --docker-server=quay.io --docker-username=${{ env.DOCKER_USERNAME }} --docker-password=${{ env.DOCKER_PASSWORD }}

      - name: Deploy to openshift
        if: always()
        run: oc apply -f deploy-to-openshift.yaml
